---
title: Analyse des accidents de la route pendant l'année 2021 en fonction du lieu,
  de la période, de l'age et du sexe
output:
  html_document:
    toc: yes
    toc_depth: 2
  pdf_document:
    toc: yes
    toc_depth: 2
---

##### Alex Delagrange, Léo Bouvier, Lucas Giry, Farah Seifeddine


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(readxl)
library(tidyverse)
library(ggplot2)
library(leaflet)
library(maps)
library(sf)
library(dplyr)
library(lubridate)
```

Dans ce rapport, nous cherchons à expliquer la gravité des accidents en France en 2021

```{r include=FALSE}
df <- read_delim("data/data.csv", delim = ";", 
    escape_double = FALSE, col_types = cols(Num_Acc = col_character(), 
        id_vehicule = col_character(), hrmn = col_time(format = "%H:%M"), 
        lat = col_character()), trim_ws = TRUE)

# ajustement sur les données

# long et lat as numeric
df$lat <- sub(",", ".", df$lat)
df$long <- sub(",", ".", df$long)
df$lat <- as.numeric(df$lat)
df$long <- as.numeric(df$long)

# magouille pour éliminer les caractères spéciaux de région
df$region <- iconv(df$region, from = "ISO-8859-1", to = "UTF-8")
df$region <- sub("ï¿½Ã®", "î", df$region)

# charcter bizarre dans id_vehicule

df$id_vehicule <- iconv(df$id_vehicule, from = "ISO-8859-1", to = "UTF-8")
df$id_vehicule <- as.character(df$id_vehicule)
```


## Etude globale sur les accidents en 2021 en France

```{r pressure, echo=FALSE, warning=FALSE}
# accidents par mois en 2021
plot_acc <- df %>% group_by(mois) %>% summarize("count" = n())

# mois nom
noms_mois <- c("janv", "févr", "mars", "avr", "mai", "juin", "juil", "août", "sept", "oct", "nov", "déc")
mois_ordre <- factor(noms_mois, levels = noms_mois)

# fonction pour associer le numéro de mois à son nom abrégé
nom_mois <- function(num_mois) {
  return(noms_mois[num_mois])
}

plot_acc$nom_mois <- factor(sapply(plot_acc$mois, nom_mois), levels = mois_ordre)

# plot
ggplot(data = plot_acc, aes(x=nom_mois, y=count)) +
  geom_col(stat="identity", fill="darkred") +
  ylab("nombre d'accidents") +
  xlab("") +
  ggtitle("Nombre d'accidents par mois en 2021")

rm(plot_acc, noms_mois)
```

```{r echo=FALSE, warning=FALSE}

# créer la colonne "heure"
# df$heure <- hms(sprintf("%02d:%02d:00", df$hrmn %/% 100, df$hrmn %% 100))

# Créer une colonne "heure_de_la_journee" contenant la tranche horaire de l'accident
df$heure_de_la_journee <- cut(as.integer(substr(df$hrmn, 1, 2)), breaks = c(-Inf, 6, 12, 18, Inf), labels = c("Nuit", "Matin", "Après-midi", "Soir"))

# Compter le nombre d'accidents par heure de la journée
accidents_par_heure <- df %>% 
  group_by(heure_de_la_journee) %>% 
  summarise(nombre_accidents = n()) %>% 
  arrange(heure_de_la_journee)

# Visualiser le nombre d'accidents par heure de la journée
ggplot(accidents_par_heure, aes(x = heure_de_la_journee, y = nombre_accidents)) +
  geom_bar(stat = "identity", fill = "darkred") +
  xlab("") +
  ylab("Nombre d'accidents") +
  ggtitle("Nombre d'accidents par période de la journée en 2021")

```



# Est ce que les usagers influencent la gravité des accidents ?

## Commençons par étudier si l'âge du conducteur est en corrélation avec la gravité de l'accident

```{r echo=FALSE, warning=FALSE}
# Sous-ensemble de données contenant l'âge et le nombre d'accidents pour chaque âge
sub_df <- df %>% filter(place == 1, catu == 1, age > 13) %>%
  group_by(age) %>% 
  summarise(nombre_accidents = n()) %>% 
  filter(!is.na(age))

# Créer un boxplot avec le nombre d'accidents sur l'axe x et l'âge sur l'axe y
ggplot(sub_df, aes(x = nombre_accidents, y = age)) +
  geom_boxplot() +
  ylab("Âge du conducteur") +
  xlab("Nombre d'accidents") +
  coord_flip() + ggtitle("Boxplot sur l'âge des conducteurs/conductrices")

# Afficher les statistiques du boxplot
print(boxplot.stats(sub_df$age))


```

Sur 126086 accidents de la route en 2021, 50 % des conducteurs ont moins de 57 ans. 50 % d'entre eux ont entre 35.5 et 78.5 ans.


Dans ce cas, l'intervalle de confiance est [49.7,64.3], ce qui signifie que l'on peut être raisonnablement sûr que la moyenne de l'âge dans la population dont l'échantillon a été prélevé se trouve dans cette plage avec une probabilité de 95%.


```{r echo=FALSE, message=FALSE, warning=FALSE}
## remettre dans l'ordre les chiffres de grav
# accidents par année de naissance en 2021
plot_usagers <- df %>% filter(catu == 1, age > 13) %>% group_by(age, grav) %>% summarize("count" = n()) %>% filter(grav == 2)
ggplot(data = plot_usagers, aes(x=age, y=count, fill=grav)) +
  geom_bar(stat="identity") + geom_smooth(se=FALSE, color = "orange") + ggtitle("Effectif des accidents mortels par âge du conducteurs")+    theme(legend.position='none') + xlab("Âge du conducteur") + ylab("Effectif")



plot_usagers <- df %>% group_by(age, grav) %>% summarize("count" = n()) %>% filter(grav == 2)
ggplot(data = plot_usagers, aes(x=age, y=count, fill=grav)) +
  geom_bar(stat="identity") + geom_smooth(se=FALSE, color = "orange") + ggtitle("Effectif des accidents mortels par âge des personnes touchées")+    theme(legend.position='none') + xlab("Âge") + ylab("Effectif")

rm(plot_usagers, plot_sexe)
```




```{r echo=FALSE, warning=FALSE}
# Sous-ensemble de données contenant la gravité de l'accident et l'âge du conducteur
sub_df <- df[, c("grav", "age")]

# Supprimer les lignes où l'âge est manquant
sub_df <- na.omit(sub_df)

# Créer un graphique de densité pour la gravité de l'accident par tranche d'âge
ggplot(sub_df, aes(x = age, fill = factor(grav))) +
  geom_density(alpha = 0.5) +
  xlab("Âge") +
  ylab("Densité") +
  scale_fill_discrete(name = "Gravité de l'accident",
                      labels = c("Indemne", "Blessé léger", "Blessé hospitalisé", "Mort")) + ggtitle("Densité des accidents par âge des personnes touchées")


```


De manière générale, le graphique de densité montre comment les distributions de l'âge des conducteurs diffèrent selon la gravité de l'accident. On remarque un fort pic de densité autour de 20 ans ce qui laisse penser à une forte corrélation entre l'age et la gravité de l'accident.



```{r echo=FALSE, warning=FALSE}
## concept de regression logistique :  il s'agit d'expliquer au mieux une variable binaire (la présence ou l'absence d'une caractéristique donnée) par des observations réelles nombreuses

# Créer une variable binaire pour la gravité de l'accident (1 si l'accident est grave, 0 sinon)
sub_df$grav_bin <- ifelse(sub_df$grav > 1, 1, 0)

# Supprimer les lignes où l'âge est manquant
sub_df <- na.omit(sub_df)

# Effectuer la régression logistique
model <- glm(grav_bin ~ age, data = sub_df, family = binomial())

# Résumé de la régression logistique
summary(model)


##############################################################################################
######################### Notes sur les significations des résultats #########################
##############################################################################################

# Call : indique la formule utilisée pour ajuster le modèle, les options et les données.
# 
# Deviance Residuals : affiche les résidus de deviance pour chaque observation. La deviance est un critère qui mesure l'ajustement du modèle aux données. Les résidus de deviance indiquent si le modèle prédit correctement la gravité de l'accident.
# 
# Coefficients : fournit les coefficients de régression estimés pour chaque variable d'entrée. Dans ce cas, il y a une seule variable d'entrée, l'âge. Pour chaque année d'augmentation de l'âge, la probabilité de subir un accident mortel diminue de 0,6 % (coefficient négatif). Le coefficient de l'interception indique la probabilité de subir un accident mortel pour une personne de 0 an (en pratique cela n'a pas de sens, il s'agit d'une propriété mathématique du modèle).
# 
# Signif. codes : indique le niveau de signification de chaque coefficient estimé. Les étoiles servent à représenter différents niveaux de significativité : *** pour un niveau très significatif, ** pour un niveau significatif, * pour un niveau de signification modéré, . pour un niveau de signification faible.
# 
# Dispersion parameter : fournit l'estimation de la variance de la distribution des résidus.
# 
# Null deviance : indique la deviance du modèle nul, c'est-à-dire un modèle qui ne contient aucune variable explicative.
# 
# Residual deviance : indique la deviance résiduelle du modèle, c'est-à-dire la deviance restante après avoir ajusté le modèle aux données.
# 
# AIC : fournit le critère d'information d'Akaike, un critère d'ajustement qui tient compte de la complexité du modèle et de l'ajustement aux données.
# 
# Number of Fisher Scoring iterations : indique le nombre d'itérations nécessaires pour estimer les paramètres du modèle.

```
Les résultats de la régression logistique indiquent que l'âge est significativement associé à la gravité des accidents. Plus précisément, pour une unité d'augmentation de l'âge, la log-odds d'avoir une gravité plus élevée diminue de 0,00667. Cela peut être interprété comme une diminution de la probabilité d'avoir une gravité plus élevée pour chaque année supplémentaire.

Le rapport des deviances (null deviance et residual deviance) montre que le modèle ajuste bien les données, car il y a une réduction significative de la deviance résiduelle par rapport à la deviance nulle. En outre, l'AIC est relativement faible, ce qui indique que le modèle est un ajustement approprié pour les données.

Le test de significativité indique que la relation entre l'âge et la gravité de l'accident est très significative (p-value < 2e-16), ce qui renforce l'idée que l'âge est un facteur important à prendre en compte dans l'évaluation de la gravité des accidents de la route.

En résumé, les résultats de la régression logistique soutiennent l'idée que l'âge est significativement associé à la gravité des accidents de la route et que le modèle est un ajustement approprié pour les données.


# Est-ce que le sexe influence la gravité des accidents ?

```{r}
sub_df <- df[, c("grav", "sexe")]

# enleve les na
sub_df <- na.omit(sub_df) %>% filter(sexe != -1)

tab <- table(sub_df$sexe, sub_df$grav)

# Conversion de la table croisée en un data frame
df_s <- as.data.frame.matrix(tab)
df_s$sexe <- rownames(df_s)

# Mise en forme des données pour un diagramme en barres empilées
df_long <- tidyr::gather(df_s, key = "grav", value = "count", -sexe)
df_long$grav <- factor(df_long$grav, levels = c("1", "2", "3", "4"))
df_long$sexe <- factor(df_long$sexe, levels = c("1", "2"))

# Convertir la variable grav en factor avec les niveaux correspondants
df_long$grav <- factor(df_long$grav, levels = 1:4,
                       labels = c("Indemne", "Mort", "Blessé hospitalisé", "Blessé léger"))

df_long$sexe <- factor(df_long$sexe, levels = 1:2,
                       labels = c("Homme", "Femme"))

# Définir les couleurs personnalisées
colors <- c("Homme" = "pink", 
            "Femme" = "lightblue")


# Réorganiser les niveaux de la variable "grav" en fonction de la fréquence
df_long$grav <- reorder(df_long$grav, desc(df_long$count))

# Créer le graphique
ggplot(df_long, aes(x = grav, fill = sexe)) +
  geom_col(position = "dodge", aes(y = count)) +
  scale_fill_manual(values = colors, name = "Sexe",
                    labels = c("Homme", "Femme")) +
  labs(title = "Gravité des accidents par sexe", x = "", y = "Nombre d'accidents") + theme_gray()


```
```{r echo=FALSE, warning=FALSE}
d <- df %>% filter(age > 13, catu == 1)

sub_df <- d[, c("grav", "sexe")]

# enleve les na
sub_df <- na.omit(sub_df) %>% filter(sexe != -1)

tab <- table(sub_df$sexe, sub_df$grav)

# Conversion de la table croisée en un data frame
df_s <- as.data.frame.matrix(tab)
df_s$sexe <- rownames(df_s)

# Mise en forme des données pour un diagramme en barres empilées
df_long <- tidyr::gather(df_s, key = "grav", value = "count", -sexe)
df_long$grav <- factor(df_long$grav, levels = c("1", "2", "3", "4"))
df_long$sexe <- factor(df_long$sexe, levels = c("1", "2"))

# Convertir la variable grav en factor avec les niveaux correspondants
df_long$grav <- factor(df_long$grav, levels = 1:4,
                       labels = c("Indemne", "Mort", "Blessé hospitalisé", "Blessé léger"))

df_long$sexe <- factor(df_long$sexe, levels = 1:2,
                       labels = c("Homme", "Femme"))

# Définir les couleurs personnalisées
colors <- c("Homme" = "pink", 
            "Femme" = "lightblue")


# Réorganiser les niveaux de la variable "grav" en fonction de la fréquence
df_long$grav <- reorder(df_long$grav, desc(df_long$count))

# Créer le graphique
ggplot(df_long, aes(x = grav, fill = sexe)) +
  geom_col(position = "dodge", aes(y = count)) +
  scale_fill_manual(values = colors, name = "Sexe",
                    labels = c("Homme", "Femme")) +
  labs(title = "Gravité des accidents par sexe du conducteur", x = "", y = "Nombre d'accidents") + theme_gray()
```


```{r echo=FALSE, warning=FALSE}
#test du X²
df_conducteurs <- df %>% filter(catu == 1, age > 13)
chisq.test(table(df_conducteurs$sexe, df_conducteurs$grav))

```
Puisque la p-value est inférieure au seuil de significativité communément utilisé de 0,05, on peut rejeter l'hypothèse nulle selon laquelle il n'y a pas d'association entre le sexe et la gravité des accidents de la route. On peut donc conclure qu'il y a une association significative entre le sexe et la gravité des accidents de la route en France en 2021.

Cela signifie que le sexe des conducteurs est statistiquement significatif pour prédire la gravité des accidents de la route en France en 2021. Cependant, il est important de noter que les résultats de ce test ne permettent pas de déterminer la direction de l'association (c'est-à-dire, si les accidents graves sont plus fréquents chez les hommes ou chez les femmes).


## Est ce que le lieux influence la gravité des accidents ?


```{r echo=FALSE, warning=FALSE}

################### carte du rapport accident_mortel / nb accidents * 100 en France en 2021


# Importer les données géographiques
regions_geojson <- st_read("https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/regions-version-simplifiee.geojson")

# Calculer le nombre d'accidents par région
df_region <- df %>%
  group_by(region) %>%
  summarise(n_accidents = n())

# Fusionner les données géographiques et les données de nombre d'accidents
map_df <- left_join(regions_geojson, df_region, by = c("nom" = "region"))

# Créer la carte
ggplot() +
  geom_sf(data = map_df, aes(fill = n_accidents)) +
  scale_fill_gradient(low = "lightyellow", high = "darkred") +
  ggtitle("Nombre d'accidents par région en France en 2021") +
  labs(fill="Nombre d'accidents") +
  theme_void()





########### carte du nombre d'accidents par région en France en 2021

# Calculer le nombre d'accidents par région
df_region <- df %>%
  group_by(region) %>%
  summarise(n_accidents = n(),
            n_accidents_mortels = sum(grav == 2),
            taux_accidents_mortels = round(sum(grav == 2)/n_accidents, 4)*100)

# Fusionner les données géographiques et les données de nombre d'accidents
map_df <- left_join(regions_geojson, df_region, by = c("nom" = "region"))

# Créer la carte
ggplot() +
  geom_sf(data = map_df, aes(fill = taux_accidents_mortels)) +
  scale_fill_gradient(low = "lightyellow", high = "darkred") +
  ggtitle("Rapport du nombre d'accidents mortels sur le nombre d'accidents par région") + 
  labs(fill = "Taux d'accidents graves") +
  theme_void()





# Créer une table de contingence croisant la région et la gravité de l'accident
cont_table <- table(df$region, df$grav)

# Effectuer le test du chi2
chi2 <- chisq.test(cont_table)
chi2


```

Le résultat du test montre une statistique de test de 6065.5 et un degré de liberté de 39, ce qui donne une p-value inférieure à 2.2e-16.

La p-value est très faible, ce qui suggère qu'il y a une forte association entre la région et la gravité de l'accident. Autrement dit, la gravité des accidents semble varier significativement selon la région où ils se produisent.


```{r echo=FALSE, warning=FALSE}
# Importer les données géographiques
deps_geojson <- st_read("https://france-geojson.gregoiredavid.fr/repo/departements.geojson")

# Calculer le nombre d'accidents par région
df_dep <- df %>%
  group_by(dep) %>%
  summarise(n_accidents = n())

# Fusionner les données géographiques et les données de nombre d'accidents
map_df <- left_join(deps_geojson, df_dep, by = c("code" = "dep"))

# Créer la carte
ggplot() +
  geom_sf(data = map_df, aes(fill = n_accidents)) +
  scale_fill_gradient2(low = "lightyellow", mid = "orange",high = "darkred", midpoint = 6000) +
  ggtitle("Nombre d'accidents par département en France en 2021") +
  labs(fill="Nombre d'accidents") +
  theme_void()




########### carte du nombre d'accidents par région en France en 2021

# Calculer le nombre d'accidents par région
df_dep <- df %>%
  group_by(dep) %>%
  summarise(n_accidents = n(),
            n_accidents_mortels = sum(grav == 2),
            taux_accidents_mortels = round(sum(grav == 2)/n_accidents, 4)*100)

# Fusionner les données géographiques et les données de nombre d'accidents
map_df <- left_join(deps_geojson, df_dep, by = c("code" = "dep"))

# Créer la carte
ggplot() +
  geom_sf(data = map_df, aes(fill = taux_accidents_mortels)) +
  scale_fill_gradient(low = "lightyellow", high = "darkred") +
  ggtitle("Rapport du nombre d'accidents mortels sur le nombre d'accidents par département") + 
  labs(fill = "Taux d'accidents graves") +
  theme_void()

# Créer une table de contingence croisant la région et la gravité de l'accident
cont_table <- table(df$dep, df$grav)

# Effectuer le test du chi2
chi2 <- chisq.test(cont_table)
chi2

```
Dans les deux résultats, la statistique de test est très élevée (6065.5 pour les régions et 10960 pour les départements), ce qui suggère qu'il existe un lien significatif entre la région/departement et la gravité de l'accident.


## Est ce que l'environnement influence la gravité des accidents ?



- Pour les usagers : 
      - on regade nb d'accidents en fonction du sexe (pour garder l'esprit féministe)
      - le nb et la gravité en fonction de l'âge
  
- Pour les véhicules : 
      - on regarde la gravité en fonction du type de véhicule (deux roues, voitures classiques etc...)
      - On regarde la gravité en fonction de la sécurité installée pour l'usager (ceinture airbag pour les voitures, casque gant veste pour les motards)

- Pour l'environnement : 
      - On regarde la gravité en fonction de la vitesse autorisée (en agglo (50km/h)n etc...)
      - On regarde le nb et la gravité en fonction de l'état de la route (mouillée, eneigée, sèche)
      - On regarde le nb et la gravité en fonction de l'éclairage de la route (nuit noire, jour, éclairage urbain etc...)

