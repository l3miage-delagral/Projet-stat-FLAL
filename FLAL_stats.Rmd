---
title: Analyse des accidents de la route pendant l'année 2021 en fonction du lieu,
  de la période, de l'age et du sexe
output:
  html_document:
    toc: yes
    toc_depth: 2
  pdf_document:
    toc: yes
    toc_depth: 2
---

##### Alex Delagrange, Léo Bouvier, Lucas Giry, Farah Seifeddine


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
library(ggplot2)
library(leaflet)
library(maps)
library(sf)
library(dplyr)
library(lubridate)
```

Dans ce rapport, nous cherchons à expliquer la gravité des accidents en France en 2021

```{r include=FALSE}
df <- read_delim("data/data.csv", delim = ";", 
    escape_double = FALSE, col_types = cols(Num_Acc = col_character(), 
        id_vehicule = col_character(), hrmn = col_time(format = "%H:%M"), 
        lat = col_character()), trim_ws = TRUE)

# ajustement sur les données

# long et lat as numeric
df$lat <- sub(",", ".", df$lat)
df$long <- sub(",", ".", df$long)
df$lat <- as.numeric(df$lat)
df$long <- as.numeric(df$long)

# magouille pour éliminer les caractères spéciaux de région
df$region <- iconv(df$region, from = "ISO-8859-1", to = "UTF-8")
df$region <- sub("ï¿½Ã®", "î", df$region)

# charcter bizarre dans id_vehicule

df$id_vehicule <- iconv(df$id_vehicule, from = "ISO-8859-1", to = "UTF-8")
df$id_vehicule <- as.character(df$id_vehicule)
```


## Etude globale sur les accidents

```{r pressure, echo=FALSE, warning=FALSE}
# accidents par mois en 2021
plot_acc <- df %>% group_by(mois) %>% summarize("count" = n())

# mois nom
noms_mois <- c("janv", "févr", "mars", "avr", "mai", "juin", "juil", "août", "sept", "oct", "nov", "déc")
mois_ordre <- factor(noms_mois, levels = noms_mois)

# fonction pour associer le numéro de mois à son nom abrégé
nom_mois <- function(num_mois) {
  return(noms_mois[num_mois])
}

plot_acc$nom_mois <- factor(sapply(plot_acc$mois, nom_mois), levels = mois_ordre)

# plot
ggplot(data = plot_acc, aes(x=nom_mois, y=count)) +
  geom_col(stat="identity", fill="darkred") +
  ylab("nombre d'accidents") +
  xlab("mois") +
  ggtitle("Nombre d'accidents par mois en 2021")

rm(plot_acc, noms_mois)
```

```{r echo=FALSE}

# créer la colonne "heure"
# df$heure <- hms(sprintf("%02d:%02d:00", df$hrmn %/% 100, df$hrmn %% 100))

# Créer une colonne "heure_de_la_journee" contenant la tranche horaire de l'accident
df$heure_de_la_journee <- cut(as.integer(substr(df$hrmn, 1, 2)), breaks = c(-Inf, 6, 12, 18, Inf), labels = c("Nuit", "Matin", "Après-midi", "Soir"))

# Compter le nombre d'accidents par heure de la journée
accidents_par_heure <- df %>% 
  group_by(heure_de_la_journee) %>% 
  summarise(nombre_accidents = n()) %>% 
  arrange(heure_de_la_journee)

# Visualiser le nombre d'accidents par heure de la journée
ggplot(accidents_par_heure, aes(x = heure_de_la_journee, y = nombre_accidents)) +
  geom_bar(stat = "identity", fill = "darkred") +
  xlab("Heure de la journée") +
  ylab("Nombre d'accidents") +
  ggtitle("Nombre d'accidents par heure de la journée en 2021")

```



## Est ce que les usagers influencent la gravité des accidents ?

# Commençons par étudier si l'âge du conducteur est en corrélation avec la gravité de l'accident

```{r}
# Sous-ensemble de données contenant l'âge et le nombre d'accidents pour chaque âge
sub_df <- df %>% 
  group_by(age) %>% 
  summarise(nombre_accidents = n()) %>% 
  filter(!is.na(age))

# Créer un boxplot avec le nombre d'accidents sur l'axe x et l'âge sur l'axe y
ggplot(sub_df, aes(x = nombre_accidents, y = age)) +
  geom_boxplot() +
  ylab("Âge du conducteur") +
  xlab("Nombre d'accidents") +
  coord_flip()

# Afficher les statistiques du boxplot
print(boxplot.stats(sub_df$age))


```

Sur 126086 accidents de la route en 2021, 50 % des personnes impliquées ont moins de 51.5 ans. 50 % d'entre eux ont entre 25 et 77.5 ans.


Dans ce cas, l'intervalle de confiance est [43.44, 59.56], ce qui signifie que l'on peut être raisonnablement sûr que la moyenne de l'âge dans la population dont l'échantillon a été prélevé se trouve dans cette plage avec une probabilité de 95%.


```{r echo=FALSE, message=FALSE, warning=FALSE}
## remettre dans l'ordre les chiffres de grav
# accidents par année de naissance en 2021
plot_usagers <- df %>% group_by(age, grav) %>% summarize("count" = n()) %>% filter(grav == 2)
ggplot(data = plot_usagers, aes(x=age, y=count, fill=grav)) +
  geom_bar(stat="identity") + geom_smooth(se=FALSE, color = "orange");

rm(plot_usagers, plot_sexe)
```

```{r echo=FALSE, warning=FALSE}
# Sous-ensemble de données contenant la gravité de l'accident et l'âge du conducteur
sub_df <- df[, c("grav", "age")]

# Supprimer les lignes où l'âge est manquant
sub_df <- na.omit(sub_df)

# Créer un graphique de densité pour la gravité de l'accident par tranche d'âge
ggplot(sub_df, aes(x = age, fill = factor(grav))) +
  geom_density(alpha = 0.5) +
  xlab("Âge du conducteur") +
  ylab("Densité") +
  scale_fill_discrete(name = "Gravité de l'accident",
                      labels = c("Indemne", "Blessé léger", "Blessé hospitalisé", "Tué"))


```
De manière générale, le graphique de densité montre comment les distributions de l'âge des conducteurs diffèrent selon la gravité de l'accident. On remarque un fort pic de densité autour de 20 ans ce qui laisse penser à une forte corrélation entre l'age et la gravité de l'accident.




## Est ce que le lieux influence les accidents ?


```{r echo=FALSE, warning=FALSE}
# Importer les données géographiques
regions_geojson <- st_read("https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/regions-version-simplifiee.geojson")

# Calculer le nombre d'accidents par région
df_region <- df %>%
  group_by(region) %>%
  summarise(n_accidents = n())

# Fusionner les données géographiques et les données de nombre d'accidents
map_df <- left_join(regions_geojson, df_region, by = c("nom" = "region"))

# Créer la carte
ggplot() +
  geom_sf(data = map_df, aes(fill = n_accidents)) +
  scale_fill_gradient(low = "lightyellow", high = "darkred") +
  ggtitle("Nombre d'accidents par région en France en 2021") +
  theme_void()
```

```{r echo=FALSE, warning=FALSE}
# Importer les données géographiques
deps_geojson <- st_read("https://france-geojson.gregoiredavid.fr/repo/departements.geojson")

# Calculer le nombre d'accidents par région
df_dep <- df %>%
  group_by(dep) %>%
  summarise(n_accidents = n())

# Fusionner les données géographiques et les données de nombre d'accidents
map_df <- left_join(deps_geojson, df_dep, by = c("code" = "dep"))

# Créer la carte
ggplot() +
  geom_sf(data = map_df, aes(fill = n_accidents)) +
  scale_fill_gradient2(low = "lightyellow", mid="darkorange", high = "darkred", midpoint = 3000) +
  ggtitle("Nombre d'accidents par département en France en 2021") +
  theme_void()
```


- Pour les usagers : 
      - on regade nb d'accidents en fonction du sexe (pour garder l'esprit féministe)
      - le nb et la gravité en fonction de l'âge
  
- Pour les véhicules : 
      - on regarde la gravité en fonction du type de véhicule (deux roues, voitures classiques etc...)
      - On regarde la gravité en fonction de la sécurité installée pour l'usager (ceinture airbag pour les voitures, casque gant veste pour les motards)

- Pour l'environnement : 
      - On regarde la gravité en fonction de la vitesse autorisée (en agglo (50km/h)n etc...)
      - On regarde le nb et la gravité en fonction de l'état de la route (mouillée, eneigée, sèche)
      - On regarde le nb et la gravité en fonction de l'éclairage de la route (nuit noire, jour, éclairage urbain etc...)

